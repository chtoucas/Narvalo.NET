<?xml version="1.0" encoding="utf-8" ?>
<Project ToolsVersion="12.0"
         InitialTargets="__InitializeMakeCustomAfterProps"
         xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!-- 
    This file is injected at the end of Narvalo.Common.props by Make.proj.
  -->

  <!-- Import NuGet publication profile properties. -->
  <Import Project="$(RepositorySettingsDir)Publish.props" />


  <!-- ### Overrides for properties defined in Narvalo.Common.props ### -->

  <PropertyGroup>
    <!-- Treat all warnings as errors. -->
    <CodeAnalysisTreatWarningsAsErrors>true</CodeAnalysisTreatWarningsAsErrors>
    <CodeContractsFailBuildOnWarnings>true</CodeContractsFailBuildOnWarnings>
    <SourceAnalysisTreatErrorsAsWarnings>true</SourceAnalysisTreatErrorsAsWarnings>

    <!-- Reports are saved in a custom location. -->
    <CodeAnalysisLogFile>$(WorkArtefactsDir)$(AssemblyName).FxCop.xml</CodeAnalysisLogFile>
    <SourceAnalysisOutputFile>$(WorkArtefactsDir)$(AssemblyName).StyleCop.xml</SourceAnalysisOutputFile>

    <!-- We don't want the Code Analysis "succeed" file to be written to 
         the custom location but it does not seem to be understood by MSBuild. 
         As a workaround, we simply disable the creation of the success file. -->
    <!--<CodeAnalysisSucceededFile>$(OutDir)$(AssemblyName).FxCop.Succeed</CodeAnalysisSucceededFile>-->
    <CodeAnalysisGenerateSuccessFile>false</CodeAnalysisGenerateSuccessFile>

    <!-- Code Contracts background checking is not available in terminal. -->
    <CodeContractsRunInBackground>False</CodeContractsRunInBackground>
  </PropertyGroup>

  <!-- Sign the assemblies. -->
  <PropertyGroup Condition=" '$(SignAssembly)' == 'true' ">
    <DefineConstants>$(DefineConstants);SIGNED_ASSEMBLY</DefineConstants>
    <SignAssembly>true</SignAssembly>
    <AssemblyOriginatorKeyFile>$(RepositorySettingsDir)Narvalo.snk</AssemblyOriginatorKeyFile>
    <DelaySign>false</DelaySign>
  </PropertyGroup>


  <!-- ### Custom Narvalo project properties ### -->

  <PropertyGroup Condition=" '$(DummyGeneratedVersion)' == 'true' ">
    <BuildGeneratedVersion>false</BuildGeneratedVersion>
  </PropertyGroup>

  <PropertyGroup>
    <!-- WARNING: This property requires IntermediateOutputPath to be initialized
         which is only true since we add this property via Make.proj, otherwise
         it is only available after importing Microsoft.Common.targets. -->
    <AssemblyVersionFile>$(IntermediateOutputPath)$(AssemblyName).Version.cs</AssemblyVersionFile>

    <PackagesConfig>$(MSBuildProjectDirectory)\packages.config</PackagesConfig>
  </PropertyGroup>


  <!-- ### NuGet packaging ### -->

  <PropertyGroup>
    <NuGetProjectDirectory>$(NuGetProjectsRoot)$(AssemblyName)\</NuGetProjectDirectory>
    <NuGetProjectFile>$(NuGetProjectDirectory)$(AssemblyName).nuproj</NuGetProjectFile>

    <NuGetProjectExists Condition=" Exists('$(NuGetProjectFile)') ">true</NuGetProjectExists>
    <NuGetProjectExists Condition=" '$(NuGetProjectExists)' != 'true' ">false</NuGetProjectExists>

    <NuGetId>$(AssemblyName)</NuGetId>
    <NuGetSpecFile>$(OutDir)$(AssemblyName).nuspec</NuGetSpecFile>

    <!-- 
      Only create a NuGet package if:
      - A NuGet project exists.
      - We are running a Release Build, ie Release Configuration.
      - The assembly is signed, ie SignAssembly is true.
      - We have a meaningful version, ie BuildGeneratedVersion is true. 
    -->
    <SkipPackage Condition=" 
      '$(NuGetProjectExists)' == 'true' 
      And '$(Configuration)' == 'Release'
      And '$(SignAssembly)' == 'true'
      And '$(BuildGeneratedVersion)' == 'true' ">false</SkipPackage>
    <SkipPackage Condition=" '$(SkipPackage)' != 'false' ">true</SkipPackage>
  </PropertyGroup>

  <!-- Import NuGet project properties. -->
  <Import Project="$(NuGetProjectFile)" Condition=" '$(SkipPackage)' != 'true' " />


  <!-- ### T4 settings ### -->

  <PropertyGroup>
    <!-- Force T4 re-generation on build.
         REVIEW: Currently disabled since our T4 templates require VS hosting. -->
    <TransformOnBuild>false</TransformOnBuild>
  </PropertyGroup>

  <Target Name="__InitializeMakeCustomAfterProps">
    <Error Text="Unable to sign the assembly. The strong name key does not exist: $(RepositorySettingsDir)Narvalo.snk"
           ContinueOnError="false"
           Condition=" '$(SignAssembly)' == 'true' And !Exists('$(RepositorySettingsDir)Narvalo.snk') " />
  </Target>
</Project>