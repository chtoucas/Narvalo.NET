<?xml version="1.0" encoding="utf-8" ?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!-- Each Visual Studio project imports this file. -->
  <PropertyGroup>
    <!-- $(SolutionDir) is only set inside Visual Studio. -->
    <SolutionDir Condition="$(SolutionDir) == '' Or $(SolutionDir) == '*Undefined*'">$(MSBuildThisFileDirectory)..\</SolutionDir>

    <!-- Only enable Source Analysis in Release mode. -->
    <SourceAnalysisEnabled Condition="'$(Configuration)' == 'Debug'">false</SourceAnalysisEnabled>
    <SourceAnalysisEnabled Condition="'$(Configuration)' == 'Release'">true</SourceAnalysisEnabled>
    <!-- We do not want a Build to fail because of StyleCop errors. -->
    <SourceAnalysisTreatErrorsAsWarnings>true</SourceAnalysisTreatErrorsAsWarnings>
    <SourceAnalysisOverrideSettingsFile>$(SolutionDir)etc\Settings.SourceAnalysis</SourceAnalysisOverrideSettingsFile>
  </PropertyGroup>

  <PropertyGroup Condition="'$(BuildFromNarvaloScript)' == 'true'">
    <!-- Only when called from Narvalo.proj, $(AnalysisOutDir) is set. -->
    <SourceAnalysisOutputFile>$(AnalysisOutDir)$(AssemblyName).StyleCop.xml</SourceAnalysisOutputFile>
    <CodeAnalysisLogFile>$(AnalysisOutDir)$(AssemblyName).FxCop.xml</CodeAnalysisLogFile>
  </PropertyGroup>

  <!-- ### StyleCop ### -->

  <!--
    The NuGet package for StyleCop does not include StyleCop.CSharp.Rules.dll.
    There is a StyleCop.MSBuild package which has everything we need but we
    do not add it directly to projects since it does ugly transforms
    on the project file. A simple workaround is to add the StyleCop.MSBuild
    package to the solution and import it included targets below.

    Now all projects depend on a specific version and when StyleCop.MSBuild
    gets updated all projects will fail to load. This is not perfect but
    at least we are immediately notified of the problem.
  -->
  <Import Project="$(SolutionDir)packages\StyleCop.MSBuild.4.7.49.0\build\StyleCop.MSBuild.Targets" />

  <Target Name="BeforeStyleCop"
          BeforeTargets="StyleCop"
          Condition="'$(StyleCopEnabled)' == 'true'">
    <Message Text="Running StyleCop Analysis on $(ProjectName)..." Importance="Low" />
  </Target>

  <Target Name="AfterStyleCop"
          AfterTargets="StyleCop"
          Condition="'$(StyleCopEnabled)' == 'true'">
    <Message Text="StyleCop Analysis Complete for $(ProjectName) -- $(StyleCopViolationCount) violation(s)"
             Importance="High" />
  </Target>
</Project>