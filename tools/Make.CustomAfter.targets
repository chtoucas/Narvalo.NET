<?xml version="1.0" encoding="utf-8" ?>
<Project ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!-- 
    This file is injected at the end of Narvalo.Common.targets by Make.proj.
  -->

  <PropertyGroup>
    <BeforeBuildDependsOn>
      $(BeforeBuildDependsOn);
      ValidateSourceAnalysisSettings;
      ValidateCodeAnalysisSettings;
      CreateAssemblyVersionInfo
    </BeforeBuildDependsOn>
  </PropertyGroup>

  <PropertyGroup>
    <AfterBuildDependsOn>
      $(AfterBuildDependsOn);
      DeleteOriginalDocumentationFiles;
      CopyBuildOutputsToArtefactsDir
    </AfterBuildDependsOn>
  </PropertyGroup>

  <PropertyGroup>
    <AfterCleanDependsOn>
      $(AfterCleanDependsOn);
      CleanCustomBuildOutputs
    </AfterCleanDependsOn>
  </PropertyGroup>
  
  <PropertyGroup>
    <!-- WARNING: This property can not be defined in one of the .props files
         since IntermediateOutputPath is only initialized after importing
         Microsoft.Common.targets. -->
    <TmpAssemblyVersionInfoFile>$(IntermediateOutputPath)$(AssemblyName).Version.cs</TmpAssemblyVersionInfoFile>
  </PropertyGroup>
  

  <!-- ### Microsoft Build Process ### -->

  <Target Name="CleanCustomBuildOutputs">
    
  </Target>

  <Target Name="CopyBuildOutputsToArtefactsDir">
   <!-- TODO: Add code contracts. -->
    <ItemGroup>
      <_Outputs Include="$(OutDir)$(AssemblyName).dll" />
      <_Outputs Include="$(OutDir)$(AssemblyName).pdb" />
      <_Outputs Include="$(OutDir)$(AssemblyName).xml" />
    </ItemGroup>
      
    <!--<Copy SourceFiles="@(_Outputs)" DestinationFolder="$(WorkArtefactsDir)" SkipUnchangedFiles="true" />-->
  </Target>

  <Target Name="CreateAssemblyVersionInfo" Condition=" '$(Make_SkipAssemblyVersionInfoCreation)' != 'true' ">
    <Message Text="Creating the build generated version file for $(AssemblyName)..." Importance="high" />

    <Warning Text="Using default assembly version for $(AssemblyName)." 
             Condition=" 
              '$(AssemblyMajorVersion)' == ''
              Or '$(AssemblyMinorVersion)' == ''
              Or '$(AssemblyPatchVersion)' == ''
              " />

    <PropertyGroup>
      <AssemblyMajorVersion Condition=" '$(AssemblyMajorVersion)' == '' ">1</AssemblyMajorVersion>
      <AssemblyMinorVersion Condition=" '$(AssemblyMinorVersion)' == '' ">0</AssemblyMinorVersion>
      <AssemblyPatchVersion Condition=" '$(AssemblyPatchVersion)' == '' ">0</AssemblyPatchVersion>
      <AssemblyPreRelaseLabel></AssemblyPreRelaseLabel>
    </PropertyGroup>
    
    <IncrementBuildAndRevisionNumbers>
      <Output TaskParameter="BuildNumber" PropertyName="_BuildNumber"/>
      <Output TaskParameter="RevisionNumber" PropertyName="_RevisionNumber"/>
    </IncrementBuildAndRevisionNumbers>
    
    <PropertyGroup>
      <_AssemblyPreRelaseLabelSuffix Condition=" '$(AssemblyPreRelaseLabel)' != '' ">-$(AssemblyPreRelaseLabel)</_AssemblyPreRelaseLabelSuffix>
      <_AssemblyInfoContent>
        <![CDATA[
//------------------------------------------------------------------------------
// <auto-generated>
// This code was generated by a tool. Changes to this file may cause incorrect
// behavior and will be lost when the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

using System.Reflection;

#if BUILD_GENERATED_VERSION
[assembly: AssemblyVersion("$(AssemblyMajorVersion).$(AssemblyMinorVersion).0.0")]
[assembly: AssemblyFileVersion("$(AssemblyMajorVersion).$(AssemblyMinorVersion).$(_BuildNumber).$(_RevisionNumber)")]
[assembly: AssemblyInformationalVersion("$(AssemblyMajorVersion).$(AssemblyMinorVersion).$(AssemblyPatchVersion)$(_AssemblyPreRelaseLabelSuffix)")]
#endif

         ]]>
      </_AssemblyInfoContent>
      <_AssemblyInfoLines>$([MSBuild]::Escape($(_AssemblyInfoContent)))</_AssemblyInfoLines>
    </PropertyGroup>

    <WriteLinesToFile Lines="$(_AssemblyInfoLines)"
                      File="$(TmpAssemblyVersionInfoFile)"
                      Overwrite="true" />

    <ItemGroup>
      <Compile Include="$(TmpAssemblyVersionInfoFile)" />
    </ItemGroup>
  </Target>


  <!-- ### Source Analysis Targets ### -->

  <Target Name="ValidateSourceAnalysisSettings">
    <Warning Text="On user request, Source Analysis has been disabled on $(ProjectName)"
             Condition=" '$(NarvaloSourceAnalysisEnabled)' == 'true' And '$(NarvaloDisableSourceAnalysisOnBuild)' == 'true' "
             ContinueOnError="true" />

    <Error Text="Unexpectedly, the value of 'StyleCopEnabled' has been overriden for $(ProjectName): '$(StyleCopEnabled)' instead '$(NarvaloSourceAnalysisEnabled)'"
             Condition=" '$(NarvaloDisableSourceAnalysisOnBuild)' != 'true' And '$(StyleCopEnabled)' != '$(NarvaloSourceAnalysisEnabled)' "
             ContinueOnError="false" />
  </Target>


  <!-- ### Code Analysis Targets ### -->

  <Target Name="ValidateCodeAnalysisSettings">
    <Warning Text="On user request, $(ProjectName) does not use the default Code Analysis ruleset: '$(NarvaloCustomCodeAnalysisRuleSet)' instead of '$(NarvaloCodeAnalysisRuleSet)'"
             Condition=" '$(NarvaloRunCodeAnalysis)' == 'true' And '$(NarvaloCustomCodeAnalysisRuleSet)' != '' "
             ContinueOnError="true" />

    <Error Text="Unexpectedly, the value of 'RunCodeAnalysis' has been overriden for $(ProjectName): '$(RunCodeAnalysis)' instead of '$(NarvaloRunCodeAnalysis)'"
             Condition=" '$(RunCodeAnalysis)' != '$(NarvaloRunCodeAnalysis)' "
             ContinueOnError="false" />
    <Error Text="Unexpectedly, the value of 'CodeAnalysisRuleSet' has been overriden for $(ProjectName): '$(CodeAnalysisRuleSet)' instead of '$(NarvaloCodeAnalysisRuleSet)'"
             Condition=" '$(NarvaloCustomCodeAnalysisRuleSet)' == '' And '$(CodeAnalysisRuleSet)' != '$(NarvaloCodeAnalysisRuleSet)' "
             ContinueOnError="false" />
    <Error Text="Unexpectedly, the value of 'CodeAnalysisRuleSet' has been overriden for $(ProjectName): '$(CodeAnalysisRuleSet)' instead of '$(NarvaloCustomCodeAnalysisRuleSet)'"
             Condition=" '$(NarvaloCustomCodeAnalysisRuleSet)' != '' And '$(CodeAnalysisRuleSet)' != '$(NarvaloCustomCodeAnalysisRuleSet)' "
             ContinueOnError="false" />
  </Target>


  <!-- ### Code Contracts Targets ### -->

  <Target Name="DeleteOriginalDocumentationFiles">
    <Message Text="Deleting original documentation files (before the Code Contracts transformation)..."
             Importance="normal" />

    <ItemGroup>
      <_OriginalDocumentationFile Include="$(OutDir)$(AssemblyName).xml.old" />
    </ItemGroup>

    <Delete Files="@(_OriginalDocumentationFile)" />
  </Target>
</Project>