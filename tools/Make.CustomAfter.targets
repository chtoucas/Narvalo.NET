<?xml version="1.0" encoding="utf-8" ?>
<Project ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!--
    This file is injected at the end of Narvalo.Common.targets by Make.proj.
  -->

  <PropertyGroup>
    <!-- WARNING: This property can not be defined in one of the .props files,
         as it should, since IntermediateOutputPath is only initialized
         after importing Microsoft.Common.targets. -->
    <TmpAssemblyVersionFile>$(IntermediateOutputPath)$(AssemblyName).Version.cs</TmpAssemblyVersionFile>
  </PropertyGroup>

  <PropertyGroup>
    <BeforeBuildDependsOn>
      $(BeforeBuildDependsOn);
      CreateAssemblyVersionFile
    </BeforeBuildDependsOn>
  </PropertyGroup>

  <PropertyGroup>
    <AfterBuildDependsOn>
      $(AfterBuildDependsOn);
      DeleteOldDocumentationFile
    </AfterBuildDependsOn>
  </PropertyGroup>

  <PropertyGroup>
    <AfterCleanDependsOn>
      $(AfterCleanDependsOn);
      DeleteTmpBuildFiles
    </AfterCleanDependsOn>
  </PropertyGroup>

  <Choose>
    <When Condition=" '$(SkipBuildGeneratedVersion)' != 'true' ">
      <PropertyGroup>
        <CreateAssemblyVersionFileDependsOn>_CreateAssemblyVersionFile</CreateAssemblyVersionFileDependsOn>
      </PropertyGroup>
    </When>
    <Otherwise>
      <PropertyGroup>
        <CreateAssemblyVersionFileDependsOn>DeleteAssemblyVersionFile</CreateAssemblyVersionFileDependsOn>
      </PropertyGroup>
    </Otherwise>
  </Choose>

  <Target Name="CreateAssemblyVersionFile" DependsOnTargets="$(CreateAssemblyVersionFileDependsOn)" />

  <Target Name="DeleteAssemblyVersionFile">
    <Delete Files="$(TmpAssemblyVersionFile)" />
  </Target>

  <!-- TODO: Move this to Make.CustomAfter.props. -->
  <PropertyGroup>
    <Nuspec>$(MSBuildProjectDirectory)\$(AssemblyName).nuspec</Nuspec>
  </PropertyGroup>
  
  <!-- TODO: Incremental build. -->
  <Target Name="CreateNuspec" Condition=" Exists('$(Nuspec)') " DependsOnTargets="_GenerateAssemblyVersions">
    <Message Text="Creating NuGet spec for $(AssemblyName)..." Importance="high" />

    <!-- TODO: Remove previous one... -->
    <CreateNuspec NuSpec="$(Nuspec)"
                  OutFile="$(OutDir)$(AssemblyName).nuspec"
                  Version="$(AssemblyInformationalVersion)" />
  </Target>

  <Target Name="DeleteOldDocumentationFile">
    <Message Text="Deleting original documentation files (before the Code Contracts transformation)..."
             Importance="normal" />

    <Delete Files="$(OutDir)$(AssemblyName).xml.old" />
  </Target>

  <Target Name="DeleteTmpBuildFiles" DependsOnTargets="DeleteAssemblyVersionFile" />


  <!-- ### Private Targets ### -->

  <!--<Target Name="_CopyArtefacts">
    <ItemGroup>
      <_Outputs Include="$(OutDir)$(AssemblyName).dll" />
      <_Outputs Include="$(OutDir)$(AssemblyName).pdb"
                Condition=" Exists('$(OutDir)$(AssemblyName).pdb') " />
      <_Outputs Include="$(OutDir)$(AssemblyName).xml"
                Condition=" Exists('$(OutDir)$(AssemblyName).xml') " />

      <_ContractsOutputs Include="$(OutDir)CodeContracts\$(AssemblyName).Contracts.dll"
                         Condition=" Exists('$(OutDir)CodeContracts\$(AssemblyName).Contracts.dll') " />
      <_ContractsOutputs Include="$(OutDir)CodeContracts\$(AssemblyName).Contracts.pdb"
                         Condition=" Exists('$(OutDir)CodeContracts\$(AssemblyName).Contracts.pdb') " />
    </ItemGroup>

    <Copy SourceFiles="@(_Outputs)" DestinationFolder="$(WorkArtefactsDir)" SkipUnchangedFiles="true" />

    <MakeDir Directories="$(WorkArtefactsDir)CodeContracts"
             Condition=" '@(_ContractsOutputs)' != '' And !Exists('$(WorkArtefactsDir)CodeContracts') " />

    <Copy SourceFiles="@(_ContractsOutputs)" DestinationFolder="$(WorkArtefactsDir)CodeContracts\" SkipUnchangedFiles="true" />
  </Target>-->

  <!-- Dynamically generate the assembly version info. -->
  <Target Name="_CreateAssemblyVersionFile" DependsOnTargets="DeleteAssemblyVersionFile;_GenerateAssemblyVersions">
    <Message Text="Creating the assembly version file for $(AssemblyName)..." Importance="high" />

    <PropertyGroup>
      <_AssemblyInfoContent>
        <![CDATA[
//------------------------------------------------------------------------------
// <auto-generated>
// This code was generated by a tool. Changes to this file may cause incorrect
// behavior and will be lost when the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

using System.Reflection;

#if BUILD_GENERATED_VERSION
[assembly: AssemblyVersion("$(AssemblyVersion)")]
[assembly: AssemblyFileVersion("$(AssemblyFileVersion)")]
[assembly: AssemblyInformationalVersion("$(AssemblyInformationalVersion)")]
#endif

         ]]>
      </_AssemblyInfoContent>
      <_AssemblyInfoLines>$([MSBuild]::Escape($(_AssemblyInfoContent)))</_AssemblyInfoLines>
    </PropertyGroup>

    <MakeDir Directories="$(IntermediateOutputPath)" Condition=" !Exists($(IntermediateOutputPath)) " />

    <WriteLinesToFile Lines="$(_AssemblyInfoLines)"
                      File="$(TmpAssemblyVersionFile)"
                      Overwrite="true" />

    <!-- Dynamically add the file to the list of sources to compile
         and add the BUILD_GENERATED_VERSION compilation symbol. -->
    <PropertyGroup>
      <DefineConstants>$(DefineConstants);BUILD_GENERATED_VERSION</DefineConstants>
    </PropertyGroup>

    <ItemGroup>
      <Compile Include="$(TmpAssemblyVersionFile)" />
    </ItemGroup>
  </Target>

  <Target Name="_GenerateAssemblyVersions">
    <Warning Text="Using default assembly version for $(AssemblyName)."
             Condition=" '$(MajorVersion)' == '' Or '$(MinorVersion)' == '' Or '$(PatchVersion)' == '' " />

    <PropertyGroup>
      <MajorVersion Condition=" '$(MajorVersion)' == '' ">1</MajorVersion>
      <MinorVersion Condition=" '$(MinorVersion)' == '' ">0</MinorVersion>
      <PatchVersion Condition=" '$(PatchVersion)' == '' ">0</PatchVersion>
      <!-- REVIEW: If the version is less than 1, there is really no reason to also use a pre-release label. -->
      <PreReleaseLabel Condition=" $(MajorVersion) &lt; 1 "></PreReleaseLabel>
    </PropertyGroup>

    <IncrementBuildAndRevisionNumbers>
      <Output TaskParameter="BuildNumber" PropertyName="_BuildNumber"/>
      <Output TaskParameter="RevisionNumber" PropertyName="_RevisionNumber"/>
    </IncrementBuildAndRevisionNumbers>

    <PropertyGroup>
      <_PreReleaseLabelSuffix Condition=" '$(PreReleaseLabel)' != '' ">-$(PreReleaseLabel)</_PreReleaseLabelSuffix>
    </PropertyGroup>

    <PropertyGroup>
      <AssemblyVersion>$(MajorVersion).$(MinorVersion).0.0</AssemblyVersion>
      <AssemblyFileVersion>$(MajorVersion).$(MinorVersion).$(_BuildNumber).$(_RevisionNumber)</AssemblyFileVersion>
      <AssemblyInformationalVersion>$(MajorVersion).$(MinorVersion).$(PatchVersion)$(_PreReleaseLabelSuffix)</AssemblyInformationalVersion>
    </PropertyGroup>
  </Target>
</Project>