<?xml version="1.0" encoding="utf-8" ?>
<Project ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!--
    Options:
    - LeanRun
    - SolutionName
    
    Other options may be found in Shared.props.
  -->
  
  <Import Project="$(MSBuildThisFileDirectory)Shared.props" />
  
  <!-- Define common Narvalo project properties. -->
  <PropertyGroup>
    <!-- If true builds behave a lot like they were run inside Visual Studio. -->
    <LeanRun Condition=" '$(LeanRun)' != 'true' ">false</LeanRun>
    
    <!-- If SolutionName is not empty, we are building a solution. -->
    <BuildingSolution Condition=" '$(SolutionName)' != '' ">true</BuildingSolution>
    <BuildingSolution Condition=" '$(SolutionName)' == '' ">false</BuildingSolution>
    
    <SolutionName Condition=" '$(BuildingSolution)' != 'true' ">Narvalo.sln</SolutionName>

    <WorkRoot>$(RepositoryRoot)work\</WorkRoot>

    <WorkArtefactsDir>$(WorkRoot)artefacts\</WorkArtefactsDir>
    <WorkStagingDir>$(WorkRoot)staging\</WorkStagingDir>
    <WorkTmpDir>$(WorkRoot)tmp\</WorkTmpDir>
  </PropertyGroup>

  <!-- Define common MSBuild project properties. -->
  <PropertyGroup>
    <BaseIntermediateOutputPath>$(WorkRoot)obj\</BaseIntermediateOutputPath>
    <IntermediateOutputPath>$(BaseIntermediateOutputPath)$(Configuration)\</IntermediateOutputPath>

    <BaseOutputPath>$(WorkRoot)bin\</BaseOutputPath>
    <OutputPath>$(BaseOutputPath)$(Configuration)\</OutputPath>

    <!-- WARNING: Solutions use "Any CPU" instead of "AnyCPU"... -->
    <Platform Condition=" '$(BuildingSolution)' == 'true' And '$(Platform)' == 'AnyCPU' ">Any CPU</Platform>
  </PropertyGroup>

  <!-- Define the SolutionFile property. -->
  <PropertyGroup>
    <SolutionFile>$(RepositoryRoot)$(SolutionName)</SolutionFile>
  </PropertyGroup>

  <!-- Define the AssemblyInfoFile property. -->
  <PropertyGroup>
    <AssemblyInfoFile>$(WorkTmpDir)AssemblyInfo.Version.cs</AssemblyInfoFile>
  </PropertyGroup>

  <!-- Define the PEVerifyLogFile property. -->
  <PropertyGroup>
    <PEVerifyLogFile>$(WorkArtefactsDir)peverify.log</PEVerifyLogFile>
  </PropertyGroup>

  <!-- Define the XUnitLogFile property. -->
  <PropertyGroup>
    <XUnitLogFile>$(WorkArtefactsDir)xunit.xml</XUnitLogFile>
  </PropertyGroup>

  <!-- Define the NuGetCommand property. -->
  <PropertyGroup>
    <NuGetCommand>$(MSBuildThisFileDirectory)NuGet\nuget.exe</NuGetCommand>
  </PropertyGroup>

  <!-- Define the VerifyBuildDummyOutput property. -->
  <PropertyGroup>
    <VerifyBuildDummyOutput>$(IntermediateOutputPath)Narvalo.Verify.out</VerifyBuildDummyOutput>
  </PropertyGroup>

  <!-- Define the AdditionalConstants property. -->
  <PropertyGroup>
    <AdditionalConstants></AdditionalConstants>
  </PropertyGroup>

  <!-- Define the AdditionalProperties property. -->
  <PropertyGroup>
    <AdditionalProperties>
      WorkArtefactsDir=$(WorkArtefactsDir)
    </AdditionalProperties>
  </PropertyGroup>

  <!-- Define the BuildProperties property. -->
  <PropertyGroup>
    <!--
      I set both OutDir and OutputPath, but I guess only one is really necessary,
      and if I had to keep one it ought to be OutDir. More documentation here:
        %ProgramFiles(x86)%\MSBuild\$(VisualStudioVersion)\Bin\Microsoft.Common.CurrentVersion.targets
      
      WARNING: When building a PCL project, MSBuild places its output inside
      a subdirectory of OutDir. To correct this, we instruct MSBuild to
      use the standard behaviour: GenerateProjectSpecificOutputFolder = false.
      
      We have 
      - first the properties shared across projects (see Shared.props).
      - then the properties necessary to use a completely different working 
        directory from the one used by VS. 
      - and finally the properties used to inject properties and targets 
        at various stages of the Narvalo projects.
    -->
    <BuildProperties>
      BuildInParallel=$(BuildInParallel);
      Configuration=$(Configuration);
      Platform=$(Platform);
      RepositoryRoot=$(RepositoryRoot);
      VisualStudioVersion=$(VisualStudioVersion);

      BaseIntermediateOutputPath=$(BaseIntermediateOutputPath);
      OutDir=$(OutputPath);
      OutputPath=$(OutputPath);
      GenerateProjectSpecificOutputFolder=false;
      
      CustomBeforeNarvaloProps=$(MSBuildThisFileDirectory)Make.CustomBefore.props;
      CustomAfterNarvaloProps=$(MSBuildThisFileDirectory)Make.CustomAfter.props;
      CustomBeforeNarvaloTargets=$(MSBuildThisFileDirectory)Make.CustomBefore.targets;
      CustomAfterNarvaloTargets=$(MSBuildThisFileDirectory)Make.CustomAfter.targets
    </BuildProperties>
  </PropertyGroup>
  
  <!-- If true, Make.Common.props has already been imported. -->
  <PropertyGroup>
    <MakeCommonPropsHasBeenImported>true</MakeCommonPropsHasBeenImported>
  </PropertyGroup>
</Project>
