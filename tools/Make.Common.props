<?xml version="1.0" encoding="utf-8" ?>
<Project ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!--
    Options:
    - BuildGeneratedVersion (default: true)
    - ContinuousBuild (default: false)
    - LeanRun (default: false)
    - SignAssembly (default: false)
    - SolutionFile (default: none)
    - VisibleInternals (default: true)

    Other options may be found in Shared.props.

    If LeanRun is true, SignAssembly and BuildGeneratedVersion are ignored.
  -->

  <!-- Import shared properties. -->
  <Import Project="$(MSBuildThisFileDirectory)Shared.props" />

  <!-- Define common Narvalo project properties. -->
  <PropertyGroup>
    <!-- If true, builds behave a lot like if they were run inside Visual Studio. Default to false. -->
    <LeanRun Condition=" '$(LeanRun)' != 'true' ">false</LeanRun>

    <!-- If true, sign the assemblies. Default to false. -->
    <SignAssembly Condition=" '$(SignAssembly)' != 'true' ">false</SignAssembly>

    <!-- If true, dynamically generate the assemblies' version. Default to true. -->
    <BuildGeneratedVersion Condition=" '$(BuildGeneratedVersion)' != 'false' ">true</BuildGeneratedVersion>

    <!-- If true, this is a CI build. Default to false. -->
    <ContinuousBuild Condition=" '$(ContinuousBuild)' != 'true' ">false</ContinuousBuild>

    <!-- If true, internals are visible. Default to true. -->
    <VisibleInternals Condition=" '$(VisibleInternals)' != 'false' ">true</VisibleInternals>

    <SolutionFile Condition=" '$(SolutionFile)' == '' ">$(RepositoryRoot)Narvalo.sln</SolutionFile>
  </PropertyGroup>

  <PropertyGroup>
    <!-- The root directory for NuGet projects. -->
    <NuProjectsRoot>$(RepositoryRoot)src\NuGet\</NuProjectsRoot>

    <WorkRoot>$(RepositoryRoot)work\</WorkRoot>

    <WorkArtefactsDir>$(WorkRoot)artefacts\</WorkArtefactsDir>
  </PropertyGroup>

  <!-- Define the ConfigurationVariant property. -->
  <PropertyGroup>
    <!-- This property is useful to distinguish between variants of the same base configuration. -->
    <ConfigurationVariant Condition=" '$(SignAssembly)' == 'true' ">+Signed</ConfigurationVariant>
    <ConfigurationVariant Condition=" '$(BuildGeneratedVersion)' == 'true' ">$(ConfigurationVariant)+SemVer</ConfigurationVariant>
    <ConfigurationVariant Condition=" '$(VisibleInternals)' == 'false' ">$(ConfigurationVariant)+NoInternals</ConfigurationVariant>
  </PropertyGroup>

  <!-- Define common MSBuild project properties. -->
  <PropertyGroup>
    <BaseIntermediateOutputPath>$(WorkRoot)obj\</BaseIntermediateOutputPath>
    <IntermediateOutputPath>$(BaseIntermediateOutputPath)$(Configuration)$(ConfigurationVariant)\</IntermediateOutputPath>

    <OutDir>$(WorkRoot)bin\$(Configuration)$(ConfigurationVariant)\</OutDir>
  </PropertyGroup>

  <!-- Define the NuGetCommand property. -->
  <PropertyGroup>
    <NuGetCommand>$(MSBuildThisFileDirectory)NuGet\nuget.exe</NuGetCommand>
  </PropertyGroup>

  <!-- Define the PEVerify properties. -->
  <PropertyGroup>
    <PEVerifyCommand>$(SDK40ToolsPath)PEVerify.exe</PEVerifyCommand>
    <PEVerifyDummyOutput>$(IntermediateOutputPath)Narvalo.Verify.out</PEVerifyDummyOutput>
    <PEVerifyLogFile>$(WorkArtefactsDir)peverify.log</PEVerifyLogFile>
  </PropertyGroup>

  <!-- Define the SecAnnotate properties. -->
  <PropertyGroup>
    <SecAnnotateCommand>$(SDK40ToolsPath)SecAnnotate.exe</SecAnnotateCommand>
    <SecAnnotateOutput>$(WorkArtefactsDir)secannotate.xml</SecAnnotateOutput>
    <SecAnnotateLogFile>$(WorkArtefactsDir)secannotate.log</SecAnnotateLogFile>
  </PropertyGroup>

  <!-- Define the XunitReportFile property. -->
  <PropertyGroup>
    <XunitReportFile>$(WorkArtefactsDir)xunit.xml</XunitReportFile>
  </PropertyGroup>

  <!-- Define the BuildProperties property. -->
  <PropertyGroup>
    <BuildProperties>
      BuildInParallel=$(BuildInParallel);
      Configuration=$(Configuration);
      Platform=$(Platform);
      RepositoryRoot=$(RepositoryRoot);
      VisualStudioVersion=$(VisualStudioVersion);
    </BuildProperties>
  </PropertyGroup>

  <PropertyGroup Condition=" '$(LeanRun)' != 'true' ">
    <!--
      There is also a legacy OutputPath property but this is no longer in use.
      More documentation here:
        %ProgramFiles(x86)%\MSBuild\$(VisualStudioVersion)\Bin\Microsoft.Common.CurrentVersion.targets

      WARNING: When building a PCL project, MSBuild places its output inside
      a subdirectory of OutDir. To correct this, we instruct MSBuild to
      use the standard behaviour: GenerateProjectSpecificOutputFolder = false.
      
      WARNING: We force the value of various paths (OutputPath, IntermediateOutputPath).
    -->
    <BuildProperties>
      $(BuildProperties);

      BaseIntermediateOutputPath=$(BaseIntermediateOutputPath);
      IntermediateOutputPath=$(IntermediateOutputPath);
      OutDir=$(OutDir);
      OutputPath=$(OutDir);
      GenerateProjectSpecificOutputFolder=false;

      CustomBeforeNarvaloCommonProps=$(MSBuildThisFileDirectory)Make.CustomBefore.props;
      CustomAfterNarvaloCommonProps=$(MSBuildThisFileDirectory)Make.CustomAfter.props;
      CustomBeforeNarvaloCommonTargets=$(MSBuildThisFileDirectory)Make.CustomBefore.targets;
      CustomAfterNarvaloCommonTargets=$(MSBuildThisFileDirectory)Make.CustomAfter.targets;

      BuildGeneratedVersion=$(BuildGeneratedVersion);
      ContinuousBuild=$(ContinuousBuild);
      NuGetCommand=$(NuGetCommand);
      NuProjectsRoot=$(NuProjectsRoot);
      SignAssembly=$(SignAssembly);
      VisibleInternals=$(VisibleInternals);
      WorkArtefactsDir=$(WorkArtefactsDir);
    </BuildProperties>
  </PropertyGroup>

  <!-- Mark Make.Common.props as already imported. -->
  <PropertyGroup>
    <MakeCommonPropsImported>true</MakeCommonPropsImported>
  </PropertyGroup>
</Project>
