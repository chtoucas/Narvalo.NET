// Copyright (c) Narvalo.Org. All rights reserved. See LICENSE.txt in the project root for license information.

namespace Narvalo.T4
{
    using System;
    using System.IO;
    using System.Reflection;
    using System.Runtime.Remoting.Messaging;

    using EnvDTE;
    using Microsoft.VisualStudio.TextTemplating;

    /// <summary>
    /// Provides a base class for generated text transformations hosted inside Visual Studio.
    /// </summary>
    public abstract class VSTemplate : TextTransformation
    {
        /// <summary>
        /// Default indentation level.
        /// </summary>
        /// <remarks>We use four spaces (no tabs) for indentation.</remarks>
        private const string INDENT = "    ";

        /// <summary>
        /// Template header format.
        /// </summary>
        private const string HEADER_FORMAT =
@"// Copyright (c) Narvalo.Org. All rights reserved. See LICENSE.txt in the project root for license information.

//------------------------------------------------------------------------------
// <auto-generated>
// This code was generated by a tool. Changes to this file may cause incorrect
// behavior and will be lost if the code is regenerated.
//
// Runtime Version: {0}
// Microsoft.VisualStudio.TextTemplating: {1}
// </auto-generated>
//------------------------------------------------------------------------------
";

        private const string COMPILER_ATTR_FORMAT =
            @"[global::System.CodeDom.Compiler.GeneratedCode(""Microsoft.VisualStudio.TextTemplating"", ""{0}"")]";

        /// <summary>
        /// Lazy factory for the DTE.
        /// </summary>
        private readonly Lazy<DTE> _dte;

        /// <summary>
        /// Lazy factory for the templating engine host.
        /// </summary>
        private readonly Lazy<ITextTemplatingEngineHost> _host;

        /// <summary>
        /// Default template's name.
        /// </summary>
        private string _name;

        /// <summary>
        /// Default namespace.
        /// </summary>
        private string _namespace;

        /// <summary>
        /// Initializes a new instance of the <see cref="VSTemplate"/> class.
        /// </summary>
        protected VSTemplate()
        {
            _host = new Lazy<ITextTemplatingEngineHost>(() => HostFactory(this));
            _dte = new Lazy<DTE>(DTEFactory);
        }

        /// <summary>
        /// Initializes a new instance of the <see cref="VSTemplate"/> class.
        /// </summary>
        /// <param name="parent">The parent text transformation.</param>
        protected VSTemplate(TextTransformation parent)
        {
            if (parent == null)
            {
                throw new ArgumentNullException("parent");
            }

            _host = new Lazy<ITextTemplatingEngineHost>(() => HostFactory(parent));
            _dte = new Lazy<DTE>(DTEFactory);
        }

        /// <summary>
        /// Gets the DTE (Development Tools Environment) service.
        /// </summary>
        /// <value>The DTE (Development Tools Environment) service.</value>
        protected DTE DTE
        {
            get { return _dte.Value; }
        }

        /// <summary>
        /// Gets the templating engine host.
        /// </summary>
        /// <value>The templating engine host.</value>
        protected ITextTemplatingEngineHost VSHost
        {
            get { return _host.Value; }
        }

        /// <summary>
        /// Gets or sets the name of the template.
        /// </summary>
        /// <remarks>If none was specified, it is inferred from the template's filename.</remarks>
        protected string Name
        {
            get
            {
                if (_name == null)
                {
                    _name = InferName();
                }

                return _name;
            }

            set
            {
                if (String.IsNullOrWhiteSpace(value))
                {
                    throw new ArgumentException("The name can not be null or blank.");
                }

                _name = value;
            }
        }

        /// <summary>
        /// Gets or sets the name of the namespace.
        /// </summary>
        /// <remarks>If none was specified, it is inferred from the template location.</remarks>
        protected string Namespace
        {
            get
            {
                if (_namespace == null)
                {
                    _namespace = InferNamespace();
                }

                return _namespace;
            }

            set
            {
                if (String.IsNullOrWhiteSpace(value))
                {
                    throw new ArgumentException("The namespace can not be null or blank.");
                }

                _namespace = value;
            }
        }

        protected bool SuppressMessage { get; set; } = false;

        /// <summary>
        /// Initializes the templating class then generates the output text of the transformation.
        /// </summary>
        /// <returns>The output text of the transformation.</returns>
        public string Execute()
        {
            Initialize();

            return TransformText();
        }

        /// <summary>
        /// Writes the file header directly into the generated output.
        /// </summary>
        protected virtual void WriteHeader()
        {
            WriteLine(HEADER_FORMAT, Environment.Version, DTE.Version);
        }

        /// <summary>
        /// Increases the indent by the default indent.
        /// </summary>
        protected void PushIndent()
        {
            PushIndent(INDENT);
        }

        /// <summary>
        /// Writes a new line directly into the generated output.
        /// </summary>
        protected void WriteLine()
        {
            WriteLine(String.Empty);
        }

        /// <summary>
        /// Write the T4 compiler attribute into the generated output.
        /// </summary>
        protected void WriteCompilerAttributes()
        {
            WriteLine(COMPILER_ATTR_FORMAT, DTE.Version);
        }

        private static ITextTemplatingEngineHost HostFactory(TextTransformation transformation)
        {
            Type transformationType = transformation.GetType();
            PropertyInfo hostProperty = transformationType.GetProperty("Host");

            if (hostProperty == null)
            {
                throw new NotSupportedException(
                    "Unable to access the templating engine host. "
                    + "Please make sure your template includes hostspecific=\"true\" "
                    + "attribute in the <#@ template #> directive.");
            }

            return (ITextTemplatingEngineHost)hostProperty.GetValue(transformation, null);
        }

        private static string InferNamespace()
        {
            return CallContext.LogicalGetData("NamespaceHint").ToString();
        }

        private string InferName()
        {
            return Path.GetFileNameWithoutExtension(VSHost.TemplateFile);
        }

        private DTE DTEFactory()
        {
            var serviceProvider = (IServiceProvider)VSHost;
            if (serviceProvider == null)
            {
                throw new NotSupportedException("Host property is null.");
            }

            var dte = serviceProvider.GetService(typeof(DTE)) as DTE;
            if (dte == null)
            {
                throw new NotSupportedException("Unable to retrieve the DTE (Development Tools Environment) service.");
            }

            return dte;
        }
    }
}
